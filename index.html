<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹æ„›ã¿ãã˜</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* ====================
           ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š (CSS)
           ==================== */
        body {
            font-family: "Yu Mincho", "Hiragino Mincho ProN", serif;
            background-color: #fff0f5; /* è–„ã„ãƒ”ãƒ³ã‚¯èƒŒæ™¯ */
            color: #4a2c2c;
            text-align: center;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-width: 600px;
            width: 100%;
            border: 2px solid #ffb7b7;
            position: relative;
            min-height: 500px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        h1, h2 { color: #d94f5c; margin-top: 0; width: 100%; }
        
        /* ç”»é¢åˆ‡ã‚Šæ›¿ãˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .screen { display: none; animation: fadeIn 0.5s ease; width: 100%; }
        .screen.active { display: block; }

        /* ãƒœã‚¿ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .btn {
            background-color: #d94f5c;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: 0.2s;
            margin: 10px;
            font-family: inherit;
        }
        .btn:hover { transform: scale(1.05); background-color: #b03a45; }
        .btn-outline { background: transparent; border: 2px solid #d94f5c; color: #d94f5c; }
        .btn-outline:hover { background: #fff0f5; }
        .btn-save { background-color: #2ecc71; border:none; } /* ç”»åƒä¿å­˜ãƒœã‚¿ãƒ³(ç·‘) */
        .btn-save:hover { background-color: #27ae60; }
        .btn-small { font-size: 0.9rem; padding: 8px 15px; }

        /* å±¥æ­´ãƒªã‚¹ãƒˆã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .history-list {
            max-height: 300px;
            overflow-y: auto;
            text-align: left;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 15px;
            border-radius: 10px;
            background: #fafafa;
            width: 100%;
            box-sizing: border-box;
        }
        .history-item {
            border-bottom: 1px dashed #ccc;
            padding: 10px;
            font-size: 0.95rem;
        }
        .history-item:last-child { border-bottom: none; }
        .history-date { font-size: 0.8rem; color: #888; margin-bottom: 4px; }
        .history-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            color: white;
            font-size: 0.8rem;
            margin-right: 5px;
        }

        /* 50å€‹ã®æœ­ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .fuda-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(35px, 1fr));
            gap: 8px;
            margin-top: 20px;
            width: 100%;
        }
        .fuda {
            height: 100px;
            background: linear-gradient(to bottom, #fde4a9, #e6c56e);
            border: 1px solid #c9a54e;
            border-radius: 4px;
            cursor: pointer;
            writing-mode: vertical-rl;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
            user-select: none;
        }
        .fuda:hover { transform: translateY(-10px); background: #fff8dc; }

        /* çµæœä¿å­˜ã‚¨ãƒªã‚¢ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        #capture-target {
            background: white; 
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            box-sizing: border-box;
        }
        .result-box {
            border: 4px double #d94f5c;
            padding: 20px;
            margin-bottom: 10px;
            position: relative;
        }
        .result-box::after { /* é€ã‹ã—æ–‡å­— */
            content: "æ‹";
            position: absolute;
            top: 10px; right: 10px;
            font-size: 4rem;
            color: rgba(217, 79, 92, 0.08);
            font-weight: bold;
            pointer-events: none;
        }
        .result-title { font-size: 2.5rem; color: #d94f5c; font-weight: bold; margin: 10px 0; }

        /* å¾…æ©Ÿã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .loading-animation {
            font-size: 4rem;
            margin: 20px 0;
            animation: shake 0.5s infinite;
        }
        @keyframes shake {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(5deg); }
            50% { transform: rotate(0deg); }
            75% { transform: rotate(-5deg); }
            100% { transform: rotate(0deg); }
        }
        .loading-text {
            font-size: 1.2rem;
            color: #d94f5c;
            font-weight: bold;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .daily-notice {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            display: none;
            width: 100%;
            box-sizing: border-box;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

<div class="container">
    <div id="screen-start" class="screen active">
        <h1>ğŸŒ¸ æ‹æ„›ã¿ãã˜ ğŸŒ¸</h1>
        <p>ã‚ãªãŸã®ä»Šã®æ‹æ¨¡æ§˜ã‚’å ã„ã¾ã™ã€‚<br>ãŠã¿ãã˜ã¯1æ—¥1å›é™å®šã§ã™ã€‚</p>
        
        <div id="already-drawn-msg" class="daily-notice">
            æœ¬æ—¥ã¯ã™ã§ã«å¼•ã„ã¦ã„ã¾ã™ã€‚<br>ä¸‹è¨˜ãƒœã‚¿ãƒ³ã‹ã‚‰ä»Šæ—¥ã®çµæœã‚’ç¢ºèªã§ãã¾ã™ã€‚
        </div>

        <button id="btn-start" class="btn" onclick="startCheck()">å ã„ã‚’å§‹ã‚ã‚‹</button>
        <button id="btn-today-result" class="btn" style="display:none;" onclick="showTodayResult()">ä»Šæ—¥ã®çµæœã‚’è¦‹ã‚‹</button>
        
        <br><br>
        <button class="btn btn-outline btn-small" onclick="showHistory()">éå»ã®å±¥æ­´ã‚’è¦‹ã‚‹</button>
    </div>

    <div id="screen-status" class="screen">
        <h2>ä»Šã®çŠ¶æ³ã‚’é¸ã‚“ã§ãã ã•ã„</h2>
        <div id="status-buttons"></div>
        <br>
        <button class="btn btn-outline btn-small" onclick="switchScreen('screen-start')">æˆ»ã‚‹</button>
    </div>

    <div id="screen-fuda" class="screen">
        <h2>ç›´æ„Ÿã§é¸ã‚“ã§ãã ã•ã„</h2>
        <p>50æœ¬ã®ã¿ãã˜æ£’ã‹ã‚‰é‹å‘½ã®1æœ¬ã‚’å¼•ã</p>
        <div class="fuda-grid" id="fuda-container"></div>
        <br>
        <button class="btn btn-outline btn-small" onclick="switchScreen('screen-status')">æˆ»ã‚‹</button>
    </div>

    <div id="screen-loading" class="screen">
        <div class="loading-animation">ğŸ—³ï¸</div>
        <p class="loading-text">é‹å‘½ã‚’è¨ºæ–­ä¸­...</p>
        <p style="font-size:0.9rem; color:#888;">å¿ƒã‚’é™ã‚ã¦ãŠå¾…ã¡ãã ã•ã„</p>
    </div>

    <div id="screen-result" class="screen">
        
        <div id="capture-target">
            <div style="font-size:0.9rem; color:#888; margin-bottom:5px;">æ‹æ„›ã¿ãã˜çµæœ</div>
            <div class="result-box">
                <div>é‹å‹¢</div>
                <div class="result-title" id="res-luck"></div>
                <hr style="border:none; border-top:1px dotted #ccc;">
                <p id="res-msg" style="font-size:1.1rem; margin:20px 0; line-height:1.6;"></p>
                <div style="background:#f9f9f9; padding:10px; border-radius:10px;">
                    ãƒ©ãƒƒã‚­ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ï¼š<span id="res-item" style="font-weight:bold;"></span>
                </div>
            </div>
            <p id="result-date-display" style="color:#888; font-size:0.8rem;"></p>
        </div>
        <button class="btn btn-save" onclick="saveResultAsImage()">ğŸ“· çµæœã‚’ç”»åƒä¿å­˜</button>
        <br>
        <button class="btn" onclick="switchScreen('screen-start')">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
    </div>

    <div id="screen-history" class="screen">
        <h2>ã‚ãªãŸã®å¼•ã„ãŸæ‹ã¿ãã˜</h2>
        <div class="history-list" id="history-container"></div>
        <br>
        <button class="btn" onclick="switchScreen('screen-start')">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
        <br><br>
        <button class="btn btn-outline btn-small" onclick="resetHistory()" style="font-size:0.8rem; border-color:#ccc; color:#999;">å±¥æ­´ãƒ»åˆ¶é™ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
</div>

<script>
    // ==========================================
    // ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ (5çŠ¶æ³ Ã— 30å€‹ = 150é€šã‚Š)
    // ==========================================
    const statuses = [
        { id: 'single', label: 'å‡ºä¼šã„å‹Ÿé›†ä¸­', color: '#ff6b6b' },
        { id: 'crush', label: 'ç‰‡æ€ã„ä¸­', color: '#feca57' },
        { id: 'dating', label: 'äº¤éš›ä¸­', color: '#48dbfb' },
        { id: 'complicated', label: 'è¤‡é›‘ãªé–¢ä¿‚', color: '#ff9ff3' },
        { id: 'married', label: 'å¤«å©¦', color: '#54a0ff' }
    ];
    const luckLevels = ['å¤§å‰', 'ä¸­å‰', 'å°å‰', 'å‰', 'æœ«å‰', 'å‡¶'];

    // 150å€‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹å¤‰æ•°
    let allFortunes = [];

    // ãƒ‡ãƒ¼ã‚¿è‡ªå‹•ç”Ÿæˆé–¢æ•°
    function initData() {
        let counter = 1;
        statuses.forEach(status => {
            for(let i=0; i<30; i++) {
                const luck = luckLevels[Math.floor(Math.random() * luckLevels.length)];
                
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆï¼ˆå®Ÿé‹ç”¨æ™‚ã¯ã“ã“ã‚’ç´°ã‹ãæ›¸ãæ›ãˆã¦ãã ã•ã„ï¼‰
                const msg = `ã€${status.label}ã€‘ã®ã‚ãªãŸã¸ã€‚No.${counter}ã®é‹å‘½ã§ã™ã€‚${luck}ãªå±•é–‹ãŒå¾…ã£ã¦ã„ã¾ã™ã€‚ç›´æ„Ÿã‚’ä¿¡ã˜ã¦é€²ã¿ã¾ã—ã‚‡ã†ã€‚`;
                
                allFortunes.push({
                    id: counter,
                    statusId: status.id,
                    luck: luck,
                    msg: msg,
                    item: 'ãƒ©ãƒƒã‚­ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ' + counter
                });
                counter++;
            }
        });
    }
    initData();

    // ==========================================
    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
    // ==========================================
    let currentStatusId = '';
    let historyLog = JSON.parse(localStorage.getItem('loveOmikujiHistory')) || [];
    let pendingResult = null; // æ¼”å‡ºå¾…ã¡ã®çµæœä¿æŒç”¨

    // ä»Šæ—¥ã®æ—¥ä»˜å–å¾— (YYYY-MM-DD)
    function getTodayString() {
        const d = new Date();
        return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
    }

    // èª­ã¿è¾¼ã¿æ™‚å‡¦ç†
    window.onload = function() {
        updateStartScreen();
    };

    // ãƒˆãƒƒãƒ—ç”»é¢ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆï¼ˆ1æ—¥1å›åˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼‰
    function updateStartScreen() {
        const lastDrawDate = localStorage.getItem('lastDrawDate');
        const today = getTodayString();
        const startBtn = document.getElementById('btn-start');
        const resultBtn = document.getElementById('btn-today-result');
        const msgDiv = document.getElementById('already-drawn-msg');

        if (lastDrawDate === today) {
            // ä»Šæ—¥æ¸ˆã¿
            startBtn.style.display = 'none';
            resultBtn.style.display = 'inline-block';
            msgDiv.style.display = 'block';
        } else {
            // ã¾ã 
            startBtn.style.display = 'inline-block';
            resultBtn.style.display = 'none';
            msgDiv.style.display = 'none';
        }
    }

    // ç”»é¢é·ç§»
    function switchScreen(screenId) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        if(screenId === 'screen-start') updateStartScreen();
    }

    // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³å‡¦ç†
    function startCheck() {
        const lastDrawDate = localStorage.getItem('lastDrawDate');
        const today = getTodayString();

        if (lastDrawDate === today) {
            alert('ãŠã¿ãã˜ã¯1æ—¥1å›ã¾ã§ã§ã™ã€‚');
            showTodayResult();
            return;
        }
        goToStatus();
    }

    // çŠ¶æ³é¸æŠãƒœã‚¿ãƒ³ç”Ÿæˆ
    function goToStatus() {
        const btnContainer = document.getElementById('status-buttons');
        btnContainer.innerHTML = ''; 
        statuses.forEach(status => {
            const btn = document.createElement('button');
            btn.className = 'btn btn-outline';
            btn.innerText = status.label;
            btn.onclick = () => selectStatus(status.id);
            btnContainer.appendChild(btn);
        });
        switchScreen('screen-status');
    }

    // æœ­é¸æŠç”»é¢ã¸
    function selectStatus(id) {
        currentStatusId = id;
        const available = getAvailableFortunes(id);
        
        if (available.length === 0) {
            alert('ã“ã®ã‚«ãƒ†ã‚´ãƒªã®ãŠã¿ãã˜ã¯å…¨ã¦å¼•ãçµ‚ã‚ã‚Šã¾ã—ãŸï¼\nå±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        generateFuda();
        switchScreen('screen-fuda');
    }

    // ã¾ã å¼•ã„ã¦ã„ãªã„ãã˜ã‚’å–å¾—
    function getAvailableFortunes(statusId) {
        const drawnIds = historyLog.map(log => log.id);
        return allFortunes.filter(f => f.statusId === statusId && !drawnIds.includes(f.id));
    }

    // 50å€‹ã®æœ­ç”Ÿæˆ
    function generateFuda() {
        const container = document.getElementById('fuda-container');
        container.innerHTML = ''; 
        for (let i = 1; i <= 50; i++) {
            const fuda = document.createElement('div');
            fuda.className = 'fuda';
            fuda.innerText = 'æ‹ã¿ãã˜';
            fuda.onclick = () => drawOmikuji();
            fuda.style.animationDelay = `${i * 0.01}s`;
            container.appendChild(fuda);
        }
    }

    // ãã˜å¼•ãå®Ÿè¡Œï¼ˆæ¼”å‡ºé–‹å§‹ï¼‰
    function drawOmikuji() {
        const available = getAvailableFortunes(currentStatusId);
        if (available.length === 0) return;

        // çµæœã‚’å…ˆã«æ±ºå®š
        pendingResult = available[Math.floor(Math.random() * available.length)];
        
        // æ¼”å‡ºç”»é¢ã¸
        switchScreen('screen-loading');
        
        // 5ç§’å¾Œã«çµæœè¡¨ç¤º
        setTimeout(() => { finalizeDraw(); }, 5000);
    }

    // çµæœç¢ºå®šå‡¦ç†
    function finalizeDraw() {
        if (!pendingResult) return;
        
        // æ—¥ä»˜ã‚’è¨˜éŒ²ã—ã¦åˆ¶é™ã‚’ã‹ã‘ã‚‹
        localStorage.setItem('lastDrawDate', getTodayString());
        
        saveHistory(pendingResult);
        displayResult(pendingResult);
        pendingResult = null;
    }

    // çµæœç”»é¢æç”»
    function displayResult(result, isReplay = false) {
        document.getElementById('res-luck').innerText = result.luck;
        // å¤§å‰ãƒ»ä¸­å‰ãªã‚‰èµ¤æ–‡å­—
        document.getElementById('res-luck').style.color = (['å¤§å‰','ä¸­å‰'].includes(result.luck)) ? '#ff4757' : '#d94f5c';
        document.getElementById('res-msg').innerText = result.msg;
        document.getElementById('res-item').innerText = result.item;
        
        const dateStr = result.date || new Date().toLocaleString();
        document.getElementById('result-date-display').innerText = isReplay ? `å¼•ã„ãŸæ—¥: ${dateStr}` : 'ãŸã£ãŸä»Šå¼•ãã¾ã—ãŸ';

        switchScreen('screen-result');
    }

    // ç”»åƒä¿å­˜å‡¦ç† (html2canvasä½¿ç”¨)
    function saveResultAsImage() {
        const target = document.getElementById('capture-target');
        html2canvas(target, { scale: 2, backgroundColor: "#ffffff" }).then(canvas => {
            const link = document.createElement('a');
            link.download = `omikuji_${getTodayString()}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
        }).catch(err => {
            alert("ç”»åƒã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        });
    }

    // ä»Šæ—¥å¼•ã„ãŸçµæœã‚’å†è¡¨ç¤º
    function showTodayResult() {
        if (historyLog.length > 0) {
            displayResult(historyLog[0], true);
        } else {
            localStorage.removeItem('lastDrawDate');
            location.reload();
        }
    }

    // å±¥æ­´ä¿å­˜
    function saveHistory(result) {
        const date = new Date();
        const dateStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
        
        const logData = {
            ...result,
            date: dateStr,
            statusLabel: statuses.find(s => s.id === result.statusId).label,
            statusColor: statuses.find(s => s.id === result.statusId).color
        };
        
        historyLog.unshift(logData);
        localStorage.setItem('loveOmikujiHistory', JSON.stringify(historyLog));
    }

    // å±¥æ­´è¡¨ç¤º
    function showHistory() {
        const container = document.getElementById('history-container');
        container.innerHTML = '';
        if (historyLog.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#999;">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        } else {
            historyLog.forEach(log => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <div class="history-date">${log.date}</div>
                    <div style="display:flex; align-items:center;">
                        <span class="history-badge" style="background:${log.statusColor}">${log.statusLabel}</span>
                        <span style="font-weight:bold; color:#d94f5c;">${log.luck}</span>
                    </div>
                    <div style="font-size:0.9rem; margin-top:5px;">${log.msg}</div>
                `;
                container.appendChild(item);
            });
        }
        switchScreen('screen-history');
    }

    // ãƒªã‚»ãƒƒãƒˆå‡¦ç†
    function resetHistory() {
        if(confirm('å±¥æ­´ã¨ã€Œ1æ—¥1å›åˆ¶é™ã€ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
            localStorage.removeItem('loveOmikujiHistory');
            localStorage.removeItem('lastDrawDate');
            historyLog = [];
            location.reload();
        }
    }
</script>

</body>

</html>
